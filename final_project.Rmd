---
title: "Environmental Niche Modelling in R"
author: "Jack Richardson u7291420"
date: "4/10/23"
output:  
    html_document:
        toc: true
        toc_depth: 4
        theme: cosmo
        number_sections: false
        toc_float: true
        highlight: pygments
        fig_width: 8
        fig_height: 4
editor_options: 
  markdown: 
    wrap: 72
---

# Word/figure count

Words: [The number of words in your document, calculated using the
word_count() function at the end of this document] Figures: [The number
of figures in your document. You can just count these]

# Location on GitHub

<https://github.com/JackRicho/DS4B-final-project>

# Data Description

[A brief (\~100-200 words should be more than enough) description of the
dataset, referencing any key publications that go with it]

This project uses 3 datasets:

Atlas of Living Australias most current (as of 18/10/22) platypus occurrence records with no exclusions to data. Collected through a variety of research, conservation work and citizen science

Bioclimatic environment data that represents annual trends in climate, rainfall and seasonalty. Standard set of variables used in Species Distribution Modeling

Rivers Dataset containing geospatial point locations of Australia and New Zealand Rivers derived from World Wildlife Fund's (WWF) HydroSHEDS drainage direction layer and a stream network layer.

# Questions/Aims

This project has 2 aims:

-   To create a species distribution model of Platypus using the bioclim
    model.

-   To create a tool whereby users can input a location and they are
    told the suitability of that place to platypus habitation, and are
    told the nearest river where they may be able to find platypus

# Loading Libraries
```{r}
library(sf)
library(rgdal)
library(dplyr)
library(devtools)
library(ENMTools)
library(tidyverse)
library(leaflet)
library(terra)
```


# Raw data

[Explains how and where to get the exact raw data you got] [Is
reproducible by a person (required) and a machine (ideally)]

## Platypus Observation Data
Platypus Data: Available through Atlas of Living Australia. Search:
*Ornithorhynchus anatinus*

available here:
<https://bie.ala.org.au/species/https://biodiversity.org.au/afd/taxa/ac61fd14-4950-4566-b384-304bd99ca75f>

acquired 18-10-2023 with no data exclusions.
Renamed (Speciescommonname)DD-MM-YY i.e. Platypus18-10-23

```{r}
# Read Platypus Data
raw_platypus <- read.csv("raw_data/Platypus18-10-23.csv")
```

## Rivers of Australia & NZ Data
Rivers Data: Available through Food and Agriculture Organization of the
United Nations: /AQUASTAT/Rivers of Australia and New Zealand
In ERSI data format (geospatial data)

available here:
<https://data.apps.fao.org/catalog/iso/6a53d768-1e20-46ea-92a8-c4040286057d>

```{r}
# Find Rivers Layer
ogrListLayers("raw_data/rivers_australia_37252")

# Read Rivers Data
raw_rivers <- sf::st_read(dsn = "raw_data/rivers_australia_37252", layer = "rivers_australia_37252")
```
## Environmental Variables and BioClim Raster Data
Environment Data:
Environment data available through raster package
```{r}
# Get Environment Data
env <- raster::getData(name = "worldclim", res = 10, var = "bio")
```


# Data wrangling

[R chunks and prose which:] [Tidies up your raw data, outputs
tidied_data.csv] [Cleans up your tidied data, outputs cleaned_data.csv]

## Cleaning Platypus Data
Clean platypus Data
```{r}
# Remove duplicates
  # We will assume that if the date, location and recorder is the same, then the result is a duplicate
  # The Location change should prevent filtering out multiple sightings in one day
cleaning_platypus <- raw_platypus %>%
  distinct(eventDate, decimalLatitude, decimalLongitude, recordedBy, .keep_all = TRUE)
  # From 20077
  # To 18662
  # Removed 1415 results

# Remove absence
cleaning_platypus <- filter(cleaning_platypus, occurrenceStatus == "PRESENT")

# Remove Location Uncertianty over 10,000m
cleaning_platypus <- filter(cleaning_platypus, coordinateUncertaintyInMeters <= 10000)

#Finalise cleaning
platypus <- cleaning_platypus
```

## Cleaning River Data
Clean Rivers Data

The following areas lie significantly outside of platypus habitats, and will thus be filtered from data to lessen computational load:

- Australia, North Coast
- Australia, West Coast
- New Zealand
- South Pacific Islands

Australia, interior slightly overlaps with some recorded sightings of platypus, so should be included in the dataset. Removing rivers will not effect the model

```{r}
ausRegionKeep <- c(
  "Australia, East Coast", 
  "Australia, South Coast",
  "Australia, Interior", 
  "Murray - Darling", 
  "Tasmania")

rivers <- filter(raw_rivers, MAJ_NAME == ausRegionKeep)

# Create blank dataframe to add data to
SortedRivers <- data.frame(matrix(ncol = 5, nrow = 0, dimnames = list(NULL, c("ARCID", "decimalLongitude", "decimalLatitude", "MAJ_NAME", "SUB_NAME"))))


###

# Isolate the river geometry (list form of each point of river)
geometry_column <- rivers$geometry

# # Extract Latitudes and Longitudes into new objects
# coordinates <- st_coordinates(geometry_column)
# latitudes <- coordinates[, "Y"]
# longitudes <- coordinates[, "X"]

# # Convert from list to dataframe
# latitudesDF <- as.data.frame(latitudes)
# longitudesDF <- as.data.frame(longitudes)
# 
# # Merge into one dataframe
# riversLatLong <- latitudesDF
# riversLatLong <- riversLatLong %>%
#   mutate(longitudes = longitudesDF$longitudes)



###


# Extracting the point data
  # Note. This will take up to 10 minutes to complete. To see progress, uncomment bellow code before running
for (x in 1:nrow(rivers)) {

  # Unnest coordinates from list
  coordinates <- st_coordinates(geometry_column[x])

  for (y in 1:nrow(coordinates)) {
    tempDF <- data.frame(
      "ARCID" = as.integer(rivers[[x, "ARCID"]]),
      "decimalLongitude" = coordinates[y, "Y"],
      "decimalLatitude" = coordinates[y, "X"],
      "MAJ_NAME" = rivers[[x, "MAJ_NAME"]],
      "SUB_NAME" = rivers[[x, "SUB_NAME"]])

    # use rbind() to add row to bottom of dataframe
  SortedRivers <- rbind(SortedRivers, tempDF)

  # Uncomment below code to see progress
  ## cat("Progress:   ", x, " of " nrow(rivers), "      ")
  }
}

write.csv(SortedRivers, "processed_data/SortedRivers.csv")

SortedRivers <- read.csv("processed_data/SortedRivers.csv")

ggplot(SortedRivers, aes(x = decimalLongitude, y = decimalLatitude, colour = MAJ_NAME)) +
  geom_point()

```

## Cleaning Environmental Variable Data
Environmental data
```{r}
# Trim down the environmental layer to frame data better, include Australia only
env <- crop(env, extent(110, 155, -45, -8))

bioclimVariables <-data.frame(
  BIO = c(
    "BIO1", 
    "BIO2", 
    "BIO3", 
    "BIO4", 
    "BIO5", 
    "BIO6", 
    "BIO7", 
    "BIO8", 
    "BIO9", 
    "BIO10", 
    "BIO11", 
    "BIO12", 
    "BIO13", 
    "BIO14", 
    "BIO15", 
    "BIO16", 
    "BIO17", 
    "BIO18", 
    "BIO19"),
  Name = c(
    "Annual Mean Temperature (C*100)", 
    "Mean Diurnal Range (Mean of monthly (max temp - min temp)) (C*100)", 
    "Isothermality (BIO2/BIO7) (×100)", 
    "Temperature Seasonality (standard deviation ×100)", 
    "Max Temperature of Warmest Month (C*100)", 
    "Min Temperature of Coldest Month (C*100)", 
    "Temperature Annual Range (BIO5-BIO6) (C*100)", 
    "Mean Temperature of Wettest Quarter (C*100)", 
    "Mean Temperature of Driest Quarter (C*100)", 
    "Mean Temperature of Warmest Quarter (C*100)", 
    "Mean Temperature of Coldest Quarter (C*100)", 
    "Annual Precipitation (mm)", 
    "Precipitation of Wettest Month (mm)", 
    "Precipitation of Driest Month (mm)", 
    "Precipitation Seasonality (Coefficient of Variation) (mm)", 
    "Precipitation of Wettest Quarter (mm)", 
    "Precipitation of Driest Quarter (mm)", 
    "Precipitation of Warmest Quarter (mm)", 
    "Precipitation of Coldest Quarter (mm)")
)
```


# Sanity checks

[R chunks and prose which perform sanity checks on your cleaned data]
[Remember that this really just summarises that your data are OK after
you've cleaned them] [Most of the real sanity checks and data cleaning
go on in the data_cleaning.Rmd file]

## Environment Sanity Checks

```{r}
# Check Environment Data
for (x in 1:19) {
  plot(env[[x]], main = bioclimVariables$Name[x])
}

  # Framing is good
  # Environmental factors look good
```

## Platypus Sanity Checks

```{r}
library(rnaturalearth)
australia <- ne_countries(country = "Australia", returnclass = "sf")

map <- ggplot() +
  geom_sf(data = australia) +
  theme_void()

map_with_points <- map +
  geom_point(data = platypus, aes(x = decimalLongitude, y = decimalLatitude), size = 0.1)

print(map_with_points)
```
## River Coordinate Point Extraction & Sanity Checks

```{r}
# # Look at rivers Data
# Plot points to ensure large amount of rivers in australia contained within dataset
# And overlay platypus sightings to ensure most areas are located close to findable river

rivers_map_with_points <- map +
  geom_point(data = SortedRivers, aes(x = decimalLongitude, y = decimalLatitude), size = 0.1) +
  geom_point(data = platypus, aes(x = decimalLongitude, y = decimalLatitude), size = 0.1, colour = 'red')

print(rivers_map_with_points)
```


# Addressing the questions/aims

## Creating a bioclim model
```{r}
# Create DF with only required data
platypusPresenceDF <- platypus %>% 
  dplyr::select(decimalLongitude, decimalLatitude)
  # I have attempted to create this in the SpatRaster format, however it encounters issues down the line. Will work fine


# We package each lineage up in an ENMtools species object

# Creates empty object with slots for various values
platypusENM <- enmtools.species()

#Inhabit columns with required data
platypusENM$species.name <- "Ornithorhynchus anatinus"
platypusENM$presence.points <- platypusPresenceDF

# Check format of the enmtools.species
platypusENM <- check.species(platypusENM)
  # Populates object with required missing data
```

## Maximum Entropy Models

```{r}
# enmTools package has functions that can create maximum entropy models
platypus.mx <- enmtools.maxent(platypusENM, env)

# Show 
platypus.mx$response.plots

```

Understanding Maximum Entropy Plots:

Green is distribution of Environmental variable across background, These
are the presence of environments that fit this condition across
Australia

Red is distribution of presence points (frequency of which species
appears across those variables)

Suitability Function our model has estimated (Marginal suitability)

```{r}
# See Maximum Entropy Data evaluation
platypus.mx$training.evaluation
```

## BioClim Model

```{r}
# Use enmTools to create a bioclim model
platypus.bc <- enmtools.bc(platypusENM, env, test.prop = 0.3)
  # Bioclim uses the presence of observed insances and analyses them in relation to our 19 climatic variables to create a suitability plot
  # test.prop sets aside 30% of our data, allowing us to assess the accuracy of the model

# Create an interactive plot to view the model
interactive.plot.enmtools.model(platypus.bc)
```

## Platypus Suitability Locator
Getting input to find platypus suitability

```{r}
# Current Location platypus suitability
inputLatitude <- -35.272240
inputLongitude <- 149.121528

suitability_value <- extract(platypus.bc$suitability, cbind(inputLongitude, inputLatitude))
suitability_value <- as.numeric(suitability_value)

cat("Locations suitability value: ", suitability_value)
```

## Local River Finder
```{r}
# Current Location nearest river

# Using Haversine equation to find the nearest river:

# Function to calculate Haversine distance
nearestRiver <- function(lat1, lon1, lat2, lon2) {
  # Radius of the Earth in km
  earthRadius <- 6371
  
  # Convert degrees to radians
  lat1 <- lat1 * pi / 180
  lon1 <- lon1 * pi / 180
  lat2 <- lat2 * pi / 180
  lon2 <- lon2 * pi / 180
  
  # Haversine formula
  dlat <- lat2 - lat1
  dlon <- lon2 - lon1
  a <- sin(dlat/2)^2 + cos(lat1) * cos(lat2) * sin(dlon/2)^2
  c <- 2 * atan2(sqrt(a), sqrt(1-a))
  distance <- earthRadius * c
  
  return(distance)
}

# Calculate distances and find the nearest point
distances <- sapply(1:nrow(SortedRivers), function(i) {
  nearestRiver(inputLatitude, inputLongitude, SortedRivers$decimalLatitude[i], SortedRivers$decimalLongitude[i])
})

# Find the index of the minimum distance
nearest_point_index <- which.min(distances)

# Get the nearest point
nearest_point <- SortedRivers[nearest_point_index, ]

# Print the nearest point and distance
cat("Nearest Point:\n",
    "Latitude:", nearest_point$decimalLatitude, "\n",
    "Longitude:", nearest_point$decimalLongitude, "\n",
    "Distance (in km):", distances[nearest_point_index], "\n",
    "River Name:", nearest_point$SUB_NAME)
```


# References

[References you have cited throughout your text]
